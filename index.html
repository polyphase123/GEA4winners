<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Energy Auction (GEA-4) Winners</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- LeafletJS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .sort-arrow { display: inline-block; margin-left: 5px; opacity: 0.5; transition: opacity 0.2s; }
        th:hover .sort-arrow { opacity: 1; }
        .leaflet-container { z-index: 10; }
        .leaflet-popup-content { font-family: 'Inter', sans-serif; }
        #projects-table-body tr { cursor: pointer; }
        /* Modal styles */
        #project-modal { transition: opacity 0.3s ease-in-out; }
        #project-modal-content { transition: transform 0.3s ease-in-out; }
        .panel-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .panel-arrow { transition: transform 0.3s; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <div id="wind-turbine" class="mx-auto mb-4 w-24 h-36 cursor-pointer" title="Click me!">
                <svg viewBox="0 0 100 150" class="w-full h-full">
                    <path d="M 47 150 L 47 55 C 47 52, 53 52, 53 55 L 53 150 Z" fill="#e5e7eb"/>
                    <circle cx="50" cy="50" r="8" fill="#d1d5db"/><circle cx="50" cy="50" r="7" fill="#e5e7eb"/>
                    <g id="turbine-blades" style="transform-origin: 50px 50px;">
                        <g><path d="M 50 50 C 48 48, 47 20, 50 2 L 50 2 C 53 20, 52 48, 50 50 Z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="0.5"/><path d="M 50 2 C 48 5, 48 8, 50 10 C 52 8, 52 5, 50 2 Z" fill="#ef4444"/></g>
                        <g transform="rotate(120, 50, 50)"><path d="M 50 50 C 48 48, 47 20, 50 2 L 50 2 C 53 20, 52 48, 50 50 Z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="0.5"/><path d="M 50 2 C 48 5, 48 8, 50 10 C 52 8, 52 5, 50 2 Z" fill="#ef4444"/></g>
                        <g transform="rotate(240, 50, 50)"><path d="M 50 50 C 48 48, 47 20, 50 2 L 50 2 C 53 20, 52 48, 50 50 Z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="0.5"/><path d="M 50 2 C 48 5, 48 8, 50 10 C 52 8, 52 5, 50 2 Z" fill="#ef4444"/></g>
                    </g>
                    <circle cx="50" cy="50" r="4" fill="#f3f4f6" stroke="#6b7280" stroke-width="1"/>
                </svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Green Energy Auction (GEA-4) Winners</h1>
            <p class="text-sm text-red-600 mt-2">Programmed by Engr. Franz Xyrlo I. Tobias, PEE</p>
        </header>

         <!-- Map Section -->
        <div id="map" class="w-full h-96 md:h-[500px] mb-8 rounded-2xl shadow-lg border-2 border-white"></div>
        <p class="text-xs text-center text-gray-500 -mt-6 mb-8">Note: Project locations are preliminary and currently under review. A comprehensive update with precise coordinates is scheduled for the end of September 2025.</p>

        <!-- Subscription Panels -->
        <div class="space-y-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <button id="rate-panel-toggle" class="w-full text-left font-bold text-lg text-gray-800 flex justify-between items-center">
                    <span>GEA-4 Subscription Rates (%)</span>
                    <span id="rate-arrow" class="panel-arrow">▼</span>
                </button>
                <div id="rate-panel-content" class="panel-content"></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <!-- Filters Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                <div>
                    <label for="search-filter" class="block text-sm font-medium text-gray-700 mb-1">Search Project/Dev</label>
                    <input type="text" id="search-filter" placeholder="e.g., Citicore..." class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                </div>
                 <div>
                    <label for="grid-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Grid</label>
                    <select id="grid-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="all">All Grids</option>
                        <option value="Luzon">Luzon</option>
                        <option value="Visayas">Visayas</option>
                        <option value="Mindanao">Mindanao</option>
                    </select>
                </div>
                <div>
                    <label for="year-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year</label>
                    <select id="year-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="all">All Years</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                    </select>
                </div>
                <div>
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Technology</label>
                    <select id="type-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="all">All Technologies</option>
                    </select>
                </div>
                <div>
                    <label for="developer-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Developer</label>
                    <select id="developer-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="all">All Developers</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 pb-6 border-b">
                <div class="bg-blue-50 p-4 rounded-xl flex flex-col justify-center text-center"><div class="text-sm font-medium text-blue-800">Total Capacity (MW)</div><div id="total-capacity" class="text-2xl font-bold text-blue-900 mt-1">0</div></div>
                <div class="bg-gray-50 p-4 rounded-xl flex flex-col justify-center text-center"><div class="text-sm font-medium text-gray-800">Projects Found</div><div id="project-count" class="text-2xl font-bold text-gray-900 mt-1">0</div></div>
                <div class="lg:col-span-2 flex items-center justify-center gap-4">
                     <button id="reset-filters" class="w-full h-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors">Reset</button>
                    <button id="export-csv" class="w-full h-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">Export to CSV</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 mb-8"><div class="max-w-3xl mx-auto w-full"><h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Total Capacity by Technology (MW)</h3><canvas id="capacity-chart"></canvas></div></div>

            <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="year">Year <span class="sort-arrow">↕️</span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="grid">Grid <span class="sort-arrow">↕️</span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="type">Technology <span class="sort-arrow">↕️</span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="facilityName">Project Name <span class="sort-arrow">↕️</span></th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="developer">Developer <span class="sort-arrow">↕️</span></th><th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="capacity">Capacity (MW) <span class="sort-arrow">↕️</span></th></tr></thead><tbody id="projects-table-body" class="bg-white divide-y divide-gray-200"></tbody></table><p id="no-results" class="text-center py-8 text-gray-500 hidden">No projects match the selected filters.</p></div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500"><p>Data sourced from DOE GEA-4 Advisory No. 4 and other public records.</p></footer>
    </div>

    <!-- Project Detail Modal -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div id="project-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95">
            <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">Project Details</h2>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modal-body" class="p-6"></div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const iconColors = { "ROOF-MOUNTED SOLAR": "#F59E0B", "GROUND-MOUNTED SOLAR": "#FBBF24", "FLOATING SOLAR": "#3B82F6", "ONSHORE WIND": "#A78BFA", "IRESS": "#10B981" };
        
        const gea4Targets = {
            2026: { "Luzon": { "GROUND-MOUNTED SOLAR": 1000, "ROOF-MOUNTED SOLAR": 12, "FLOATING SOLAR": 1040, "ONSHORE WIND": 320, "IRESS": 50 }, "Visayas": { "GROUND-MOUNTED SOLAR": 240, "ROOF-MOUNTED SOLAR": 12, "FLOATING SOLAR": 0, "ONSHORE WIND": 0, "IRESS": 100 }, "Mindanao": { "GROUND-MOUNTED SOLAR": 120, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 0, "ONSHORE WIND": 0, "IRESS": 50 } },
            2027: { "Luzon": { "GROUND-MOUNTED SOLAR": 600, "ROOF-MOUNTED SOLAR": 6, "FLOATING SOLAR": 920, "ONSHORE WIND": 450, "IRESS": 50 }, "Visayas": { "GROUND-MOUNTED SOLAR": 180, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 0, "ONSHORE WIND": 170, "IRESS": 100 }, "Mindanao": { "GROUND-MOUNTED SOLAR": 30, "ROOF-MOUNTED SOLAR": 6, "FLOATING SOLAR": 0, "ONSHORE WIND": 0, "IRESS": 50 } },
            2028: { "Luzon": { "GROUND-MOUNTED SOLAR": 720, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 855, "ONSHORE WIND": 450, "IRESS": 100 }, "Visayas": { "GROUND-MOUNTED SOLAR": 480, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 25, "ONSHORE WIND": 200, "IRESS": 150 }, "Mindanao": { "GROUND-MOUNTED SOLAR": 30, "ROOF-MOUNTED SOLAR": 6, "FLOATING SOLAR": 0, "ONSHORE WIND": 0, "IRESS": 100 } },
            2029: { "Luzon": { "GROUND-MOUNTED SOLAR": 240, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 160, "ONSHORE WIND": 450, "IRESS": 100 }, "Visayas": { "GROUND-MOUNTED SOLAR": 180, "ROOF-MOUNTED SOLAR": 6, "FLOATING SOLAR": 0, "ONSHORE WIND": 150, "IRESS": 150 }, "Mindanao": { "GROUND-MOUNTED SOLAR": 120, "ROOF-MOUNTED SOLAR": 0, "FLOATING SOLAR": 0, "ONSHORE WIND": 200, "IRESS": 100 } }
        };

        // Locations updated based on research documents and user feedback
        const projects = [
            { id: 1, year: 2026, grid: "Luzon", type: "IRESS", facilityName: "Bolbok 3 Solar Power Project; Phase 1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 2, year: 2026, grid: "Visayas", type: "IRESS", facilityName: "Silay 2D Solar Power Project; Phase 1", developer: "Citicore Renewable Energy Corporation", capacity: 35.710, lat: 10.7442, lon: 123.0739 },
            { id: 3, year: 2026, grid: "Mindanao", type: "IRESS", facilityName: "Tantangan Solar Power Project; Phase 2", developer: "Apolaki Seven Inc.", capacity: 13.380, lat: 6.5717, lon: 124.7641 },
            { id: 4, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Castilla Solar Power Plant", developer: "Equator Energy Corporation", capacity: 39.984, lat: 12.964, lon: 123.871 },
            { id: 5, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Ecopark Isla Solar Power Plant", developer: "Ecopark Energy of Valenzuela Corp.", capacity: 4.035, lat: 14.73, lon: 120.98 },
            { id: 6, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Ecopark Tagalag Solar Power Plant", developer: "Ecopark Energy of Valenzuela Corp.", capacity: 14.700, lat: 14.75, lon: 120.97 },
            { id: 7, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Pagbilao 3 Solar Power Project; Phase 1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.972, lon: 121.753 },
            { id: 8, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Pagbilao 3 Solar Power Project; Phase 2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.972, lon: 121.753 },
            { id: 9, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "San Lorenzo Ruiz Solar Power Plant", developer: "East Cornerstone Development Corp.", capacity: 5.000, lat: 14.125, lon: 122.842 },
            { id: 10, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Capantolan Solar Power Project", developer: "Pacific Impact Energy Corp.", capacity: 42.000, lat: 16.071, lon: 120.095 },
            { id: 11, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Magahis Solar Power Plant Project; Phase I", developer: "Tuy Solar Power Corporation", capacity: 170.000, lat: 14.024, lon: 120.731 },
            { id: 12, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 4 Solar Power Project; Phase 1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 13, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Luntal Solar Power Project", developer: "Citicore Solar Batangas 1, Inc.", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 14, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 5 Solar Power Project; Phase 2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 15, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Lumbangan Solar Power Project", developer: "Citicore Solar Batangas 1, Inc.", capacity: 90.000, lat: 13.8121, lon: 121.2626 },
            { id: 16, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 5 Solar Power Project; Phase1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 17, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 5 Solar Power Project; Phase 3", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 18, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 4 Solar Power Project; Phase 2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 19, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bolbok 4 Solar Power Project Phase 3", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 20, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Bataan Solar Power Project", developer: "Tai Yang 1 Power Inc.", capacity: 16.500, lat: 14.8302, lon: 120.5086 },
            { id: 21, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Sual Solar Power Plant", developer: "Renovable Earth Corp.", capacity: 33.000, lat: 16.071, lon: 120.095 },
            { id: 22, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Sapang Balen Solar 2 Power Project", developer: "Sapang Balen Solar Sustainable Energy Corp.", capacity: 90.000, lat: 15.2310, lon: 120.5447 },
            { id: 23, year: 2026, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Ground Mounted Solar PV Project; Phase 1", developer: "San Ignacio Energy Resources Development Corporation", capacity: 96.473, lat: 17.1311, lon: 121.8845 },
            { id: 24, year: 2026, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Sikatuna Solar Power Project", developer: "Bohol Solar Energy Inc.", capacity: 37.884, lat: 9.6824, lon: 123.9870 },
            { id: 25, year: 2026, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Vista Alegre Solar Power Project", developer: "Amatera Renewable Energy Corporation", capacity: 50.100, lat: 10.7770, lon: 123.0149 },
            { id: 26, year: 2026, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Daanbantayan Solar Power Project", developer: "Freya Renewables Inc.", capacity: 150.000, lat: 11.261, lon: 124.025 },
            { id: 27, year: 2026, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "Pagayawan Solar Power Plant Project", developer: "Pagayawan Renewable Energy Corp.", capacity: 20.000, lat: 7.824, lon: 124.402 },
            { id: 28, year: 2026, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "Malita Solar Power Project; Phase 1", developer: "SMC Global Light and Power Corp.", capacity: 108.000, lat: 6.3935, lon: 125.6168 },
            { id: 29, year: 2026, grid: "Luzon", type: "ROOF-MOUNTED SOLAR", facilityName: "Naic Solar Rooftop Power Project", developer: "Joy-Nostalg Solaris Incorporated", capacity: 4.950, lat: 14.321, lon: 120.765 },
            { id: 30, year: 2026, grid: "Luzon", type: "ROOF-MOUNTED SOLAR", facilityName: "Ning Ning Muzon-Labac Rooftop Solar Power Project", developer: "Joy-Nostalg Solaris Incorporated", capacity: 10.497, lat: 13.784, lon: 121.052 },
            { id: 31, year: 2026, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Kalayaan 2 Wind Power Project", developer: "Laguna Wind Energy Corp.", capacity: 100.800, lat: 14.40, lon: 121.55 },
            { id: 32, year: 2026, grid: "Luzon", type: "ONSHORE WIND", facilityName: "South Eastern Wind Power Project", developer: "Econergy Renewable Power Philippines Inc.", capacity: 49.990, lat: 12.91, lon: 124.12 },
            { id: 33, year: 2027, grid: "Luzon", type: "IRESS", facilityName: "Bolbok 3 Solar Power Project Phase 2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 13.9687, lon: 120.7276 },
            { id: 34, year: 2027, grid: "Visayas", type: "IRESS", facilityName: "Barotac Viejo Solar Power Project", developer: "Magallanes Solar Energy Corp.", capacity: 67.000, lat: 11.052, lon: 122.953 },
            { id: 35, year: 2027, grid: "Visayas", type: "IRESS", facilityName: "Silay 2C Solar Power Project; Phase 1", developer: "Citicore Renewable Energy Corporation", capacity: 38.000, lat: 10.7442, lon: 123.0739 },
            { id: 36, year: 2027, grid: "Luzon", type: "IRESS", facilityName: "Titan V Solar Power Project; Phase 1", developer: "Apolaki Four Inc.", capacity: 49.700, lat: 8.55, lon: 126.38 },
            { id: 37, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Atimonan Solar Power Project", developer: "Bolo Renewable Energy Corp.", capacity: 50.000, lat: 14.004, lon: 121.916 },
            { id: 38, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Ultra Solar Power Plant Project", developer: "Bolo Renewable Energy Corp.", capacity: 68.000, lat: 14.012, lon: 121.905 },
            { id: 39, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Cauayan Solar Power Project; Phase 1", developer: "SMC Global Light and Power Corp.", capacity: 270.000, lat: 16.95, lon: 121.80 },
            { id: 40, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "San Vicente Solar Power Project", developer: "Citadel Energy Corporation", capacity: 140.000, lat: 14.115, lon: 122.885 },
            { id: 41, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Villaverde Ground-Mounted Solar-Photovoltaic Project", developer: "Verde Radiant Power Corporation", capacity: 11.840, lat: 16.513, lon: 121.012 },
            { id: 42, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Libmanan Solar Power Project", developer: "Green PV Energy Corporation", capacity: 49.900, lat: 13.692, lon: 123.064 },
            { id: 43, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Sta. Ignacia Tarlac Solar Power Plant Project Phase 1", developer: "Sta. Ignacia Tarlac Solar Power Corporation", capacity: 18.000, lat: 15.613, lon: 120.442 },
            { id: 44, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Earthlight Concepcion Solar Power Project; Phase 1", developer: "Joy-Nostalg Solaris Incorporated", capacity: 30.400, lat: 15.326, lon: 120.658 },
            { id: 45, year: 2027, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Zamboanguita Solar Power Project", developer: "Zamboanguita Solar Power Corporation", capacity: 50.000, lat: 9.156, lon: 123.205 },
            { id: 46, year: 2027, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "San Miguel Solar Power Project", developer: "Sunpalo Solar Energy, Inc.", capacity: 150.000, lat: 15.145, lon: 120.975 },
            { id: 47, year: 2027, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "Malita Solar Power Project; Phase 2", developer: "SMC Global Light and Power Corp.", capacity: 27.000, lat: 6.3935, lon: 125.6168 },
            { id: 48, year: 2027, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "SPPC Solar Power Project (Phase 1)", developer: "Alabel Solar Energy Corporation", capacity: 30.000, lat: 6.103, lon: 125.286 },
            { id: 49, year: 2027, grid: "Luzon", type: "ROOF-MOUNTED SOLAR", facilityName: "Ning Ning Catmon Sta. Maria Rooftop Solar Power Project", developer: "Joy-Nostalg Solaris Incorporated", capacity: 4.019, lat: 14.814, lon: 120.963 },
            { id: 50, year: 2027, grid: "Luzon", type: "ROOF-MOUNTED SOLAR", facilityName: "Ning Ning Dolores Magalang Rooftop Solar Power Project", developer: "Joy-Nostalg Solaris Incorporated", capacity: 5.353, lat: 15.223, lon: 120.661 },
            { id: 51, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Magat Floating Solar Power Project", developer: "Sn Aboitiz Power - Magat, Inc", capacity: 50.000, lat: 16.795, lon: 121.463 },
            { id: 52, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Cabuyao 2 Floating PV Power Plant", developer: "Nortesol Inc.", capacity: 72.000, lat: 14.305, lon: 121.151 },
            { id: 53, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Cabuyao 1 Floating PV Power Plant", developer: "Nortesol II Inc.", capacity: 72.000, lat: 14.302, lon: 121.148 },
            { id: 54, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Calamba Floating PV Solar Power Project", developer: "Norteson Incorporated", capacity: 72.000, lat: 14.240, lon: 121.180 },
            { id: 55, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Cabuyao 3 Floating PV Power Plant", developer: "Nortesol IV, Inc.", capacity: 72.000, lat: 14.299, lon: 121.153 },
            { id: 56, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Victoria 1 Floating PV Power Plant,", developer: "Nortesollv, Inc.", capacity: 72.000, lat: 14.230, lon: 121.230 },
            { id: 57, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Bay 2 Floating PV Power Plant", developer: "NortesolIV, Inc.", capacity: 72.000, lat: 14.202, lon: 121.282 },
            { id: 58, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Cabuyao 5 Floating PV Power Plant", developer: "NEWASIA POWER ENERGY II CORP.", capacity: 72.000, lat: 14.308, lon: 121.145 },
            { id: 59, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Cabuyao 4 Floating Solar PV Power Plant", developer: "NEWASIA POWER ENERGY CORP.", capacity: 72.000, lat: 14.296, lon: 121.156 },
            { id: 60, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Bay 1 Floating PV Power Plant", developer: "Newasia Power Energy Corp.", capacity: 72.000, lat: 14.199, lon: 121.279 },
            { id: 61, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Sta. Rosa Floating PV Power Plant", developer: "Newasia Power Energy II Corp.", capacity: 72.000, lat: 14.330, lon: 121.120 },
            { id: 62, year: 2027, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Macabebe Floating PV Power Plant", developer: "NEWASIA POWER ENERGY III CORP.", capacity: 95.000, lat: 14.85, lon: 120.68 },
            { id: 63, year: 2027, grid: "Visayas", type: "FLOATING SOLAR", facilityName: "Sagay Solar on Water PV Power Plant", developer: "LakeSun Energy Inc.", capacity: 70.000, lat: 10.95, lon: 123.45 },
            { id: 64, year: 2027, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Sorsogon 2 Wind Power Project", developer: "Econergy Renewable Power Philippines Inc.", capacity: 200.000, lat: 12.973, lon: 124.008 },
            { id: 65, year: 2027, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Presentacion 2 Wind Power Project", developer: "Wind Renewable Energy Corporation", capacity: 49.500, lat: 13.842, lon: 123.635 },
            { id: 66, year: 2027, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Quezon Wind Power Project (Phase 2)", developer: "Quezon Wind Energy Corp.", capacity: 208.000, lat: 14.75, lon: 121.58 },
            { id: 67, year: 2027, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Northern Wind Power Project", developer: "Econergy Renewable Power Philippines Inc.", capacity: 100.000, lat: 12.00, lon: 125.00 },
            { id: 68, year: 2027, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Cauayan Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 50.000, lat: 16.936, lon: 121.772 },
            { id: 69, year: 2028, grid: "Luzon", type: "IRESS", facilityName: "Talingaan-Laoag Solar Power Project", developer: "North Luzon Green Power, Inc.", capacity: 100.000, lat: 18.195, lon: 120.593 },
            { id: 70, year: 2028, grid: "Luzon", type: "IRESS", facilityName: "Luna Solar Power Project", developer: "South Cleanergy Inc.", capacity: 120.000, lat: 16.852, lon: 120.425 },
            { id: 71, year: 2028, grid: "Mindanao", type: "IRESS", facilityName: "Kalandagan Solar Power Project", developer: "Olympia Solar Power Corporation", capacity: 54.000, lat: 6.783, lon: 124.596 },
            { id: 72, year: 2028, grid: "Luzon", type: "IRESS", facilityName: "Titan V Solar Power Project; Phase 2", developer: "Apolaki Four Inc.", capacity: 49.700, lat: 8.55, lon: 126.38 },
            { id: 73, year: 2028, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Cauayan Solar Power Project; Phase 2", developer: "SMC Global Light and Power Corp.", capacity: 630.000, lat: 16.95, lon: 121.80 },
            { id: 74, year: 2028, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project; Phase 1-3", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 75, year: 2028, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project; Phase 1-2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 76, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Victorias Solar Power Plant", developer: "Victorias Green Energy Corp.", capacity: 85.000, lat: 10.91, lon: 123.06 },
            { id: 77, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Earthlight San Fernando Barotac Viejo Solar Power Project; Phase 1", developer: "Joy-Nostalg Solaris Incorporated", capacity: 55.500, lat: 11.052, lon: 122.953 },
            { id: 78, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Ajuy 1 Solar Power Project; Phase 2", developer: "Joy-Nostalg Solaris Incorporated", capacity: 23.967, lat: 11.173, lon: 123.024 },
            { id: 79, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Viejo Iloilo Solar Power Project", developer: "JICA Power and Development Corporation", capacity: 158.400, lat: 11.052, lon: 122.953 },
            { id: 80, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Ilog Solar Power Project", developer: "Western Visayas Solar Energy Corp.", capacity: 140.100, lat: 10.142, lon: 122.776 },
            { id: 81, year: 2028, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Bohol Solar Power Project", developer: "Bohol Renewable Power Corp. (Isla Este Renewables Corporation)", capacity: 17.500, lat: 9.85, lon: 124.46 },
            { id: 82, year: 2028, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "Malita Solar Power Project; Phase 3", developer: "SMC Global Light and Power Corp.", capacity: 30.000, lat: 6.3935, lon: 125.6168 },
            { id: 83, year: 2028, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Angat Solar Power Project; Phase 1", developer: "SMC Global Light and Power Corp.", capacity: 540.000, lat: 14.912, lon: 121.053 },
            { id: 84, year: 2028, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "San Marcelino Floating Solar Power Project", developer: "Northern Sun Radiance Inc.", capacity: 130.000, lat: 14.98, lon: 120.20 },
            { id: 85, year: 2028, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Liberty Solar Power Project; Phase B", developer: "Liberty Solar Energy Corporation", capacity: 34.000, lat: null, lon: null },
            { id: 86, year: 2028, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Liberty Solar Power Project; Phase A", developer: "Liberty Solar Energy Corporation", capacity: 34.000, lat: null, lon: null },
            { id: 87, year: 2028, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "NKS One Floating Solar Power Project; Phase 2", developer: "NKS Solar One Inc.", capacity: 47.000, lat: null, lon: null },
            { id: 88, year: 2028, grid: "Visayas", type: "FLOATING SOLAR", facilityName: "Silay Solar on Water PV Power Plant", developer: "Limnelios Inc.", capacity: 64.000, lat: 10.80, lon: 122.98 },
            { id: 89, year: 2028, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Pagsanjan Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 200.000, lat: 14.35, lon: 121.55 },
            { id: 90, year: 2028, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Tayabas North Wind Energy Project (Phase 1)", developer: "Clean Tech Global Renewables, Inc.", capacity: 96.000, lat: 14.024, lon: 121.593 },
            { id: 91, year: 2028, grid: "Luzon", type: "ONSHORE WIND", facilityName: "San Nicolas Wind Power Project", developer: "San Nicolas Wind Corp.", capacity: 200.000, lat: 18.172, lon: 120.735 },
            { id: 92, year: 2028, grid: "Visayas", type: "ONSHORE WIND", facilityName: "Alegria Wind Power Project", developer: "MC Project Solutions Inc.", capacity: 56.000, lat: 9.774, lon: 123.362 },
            { id: 93, year: 2028, grid: "Visayas", type: "ONSHORE WIND", facilityName: "Lavezares Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 50.000, lat: 12.553, lon: 124.336 },
            { id: 94, year: 2028, grid: "Visayas", type: "ONSHORE WIND", facilityName: "Leyte Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 110.000, lat: 10.05, lon: 125.25 },
            { id: 95, year: 2029, grid: "Luzon", type: "IRESS", facilityName: "Currimao Solar Power Project", developer: "Northern Sun Power, Inc.", capacity: 190.000, lat: 18.062, lon: 120.485 },
            { id: 96, year: 2029, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project: Phase 3-2", developer: "Citicore Renewable Energy Corporation", capacity: 40.000, lat: 16.90, lon: 121.75 },
            { id: 97, year: 2029, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project; Phase 2-3", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 98, year: 2029, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project; Phase 2-2", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 99, year: 2029, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project: Phase 3-1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 100, year: 2029, grid: "Luzon", type: "GROUND-MOUNTED SOLAR", facilityName: "Isabela Solar Power Project; Phase 2-1", developer: "Citicore Renewable Energy Corporation", capacity: 50.000, lat: 16.90, lon: 121.75 },
            { id: 101, year: 2029, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Earthlight San Fernando Barotac Viejo Solar Power Project; Phase 2", developer: "Joy-Nostalg Solaris Incorporated", capacity: 55.500, lat: 11.052, lon: 122.953 },
            { id: 102, year: 2029, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Dagohoy Solar Power Project", developer: "Dagohoy Green Energy Corporation", capacity: 20.160, lat: 9.943, lon: 124.235 },
            { id: 103, year: 2029, grid: "Visayas", type: "GROUND-MOUNTED SOLAR", facilityName: "Panitan Solar Power Project", developer: "EcoSolar Energy Corporation", capacity: 70.080, lat: 11.385, lon: 122.793 },
            { id: 104, year: 2029, grid: "Mindanao", type: "GROUND-MOUNTED SOLAR", facilityName: "Malita Solar Power Project; Phase 4", developer: "SMC Global Light and Power Corp.", capacity: 120.000, lat: 6.3935, lon: 125.6168 },
            { id: 105, year: 2029, grid: "Luzon", type: "FLOATING SOLAR", facilityName: "Angat Solar Power Project; Phase 2", developer: "SMC Global Light and Power Corp.", capacity: 500.000, lat: 14.912, lon: 121.053 },
            { id: 106, year: 2029, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Calabanga Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 200.000, lat: 13.715, lon: 123.214 },
            { id: 107, year: 2029, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Quezon Wind Power Project (Phase 1)", developer: "Atimonan Windkraft Corporation", capacity: 67.000, lat: 14.004, lon: 121.916 },
            { id: 108, year: 2029, grid: "Luzon", type: "ONSHORE WIND", facilityName: "Ilosong Wind Power Project (Phase 1)", developer: "Ilosong Wind Corp.", capacity: 200.000, lat: 13.58, lon: 124.23 },
            { id: 109, year: 2029, grid: "Visayas", type: "ONSHORE WIND", facilityName: "Bais Wind Project", developer: "Envision Energy Philippines Corporation", capacity: 150.000, lat: 9.593, lon: 123.124 },
            { id: 110, year: 2029, grid: "Mindanao", type: "ONSHORE WIND", facilityName: "Caraga Wind Power Project Phase 1", developer: "Caraga Wind Energy Corporation", capacity: 101.000, lat: 9.78, lon: 125.49 },
            { id: 111, year: 2029, grid: "Mindanao", type: "ONSHORE WIND", facilityName: "Caraga Wind Power Project Phase 2", developer: "Caraga Wind Energy Corporation", capacity: 50.000, lat: 9.78, lon: 125.49 },
        ];
        
        // --- DOM ELEMENTS ---
        const searchFilter = document.getElementById('search-filter');
        const gridFilter = document.getElementById('grid-filter');
        const yearFilter = document.getElementById('year-filter');
        const typeFilter = document.getElementById('type-filter');
        const developerFilter = document.getElementById('developer-filter');
        const exportBtn = document.getElementById('export-csv');
        const resetBtn = document.getElementById('reset-filters');
        const tableBody = document.getElementById('projects-table-body');
        const totalCapacityEl = document.getElementById('total-capacity');
        const projectCountEl = document.getElementById('project-count');
        const noResultsEl = document.getElementById('no-results');
        const tableHeaders = document.querySelectorAll('th[data-sort]');
        const projectModal = document.getElementById('project-modal');
        const projectModalContent = document.getElementById('project-modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const ratePanelToggle = document.getElementById('rate-panel-toggle');
        const ratePanelContent = document.getElementById('rate-panel-content');
        const rateArrow = document.getElementById('rate-arrow');


        // --- STATE & INSTANCES ---
        let sortState = { column: 'year', direction: 'asc' };
        let capacityChart, map, markerLayer;
        let currentFilteredProjects = [];
        let awardedTotals = {};
        
        // --- FUNCTIONS ---

        function calculateAwardedTotals() {
            awardedTotals = {};
            projects.forEach(p => {
                if (!awardedTotals[p.year]) awardedTotals[p.year] = { "Luzon": {}, "Visayas": {}, "Mindanao": {} };
                if (!awardedTotals[p.year][p.grid][p.type]) awardedTotals[p.year][p.grid][p.type] = 0;
                awardedTotals[p.year][p.grid][p.type] += p.capacity;
            });
        }
        
        function updateSubscriptionPanel() {
            const contentEl = ratePanelContent;
            const selectedYear = yearFilter.value;
            const selectedGrid = gridFilter.value;

            const yearsToDisplay = selectedYear === 'all' ? Object.keys(gea4Targets) : [selectedYear];
            const gridsToDisplay = selectedGrid === 'all' ? ["Luzon", "Visayas", "Mindanao"] : [selectedGrid];
            
            let html = '<div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">';
            
            yearsToDisplay.forEach(year => {
                html += `<div class="bg-gray-50 p-4 rounded-lg">`;
                html += `<h4 class="font-bold text-md mb-2 text-gray-700">${year}</h4>`;
                html += '<div class="space-y-2">';
                gridsToDisplay.forEach(grid => {
                    if (gea4Targets[year] && gea4Targets[year][grid]) {
                        html += `<div><h5 class="font-semibold text-sm text-gray-600">${grid} (Lot ${getLotNumber(year, grid)})</h5><ul class="text-xs text-gray-500 pl-4 list-disc">`;
                        Object.keys(gea4Targets[year][grid]).forEach(tech => {
                            const target = gea4Targets[year][grid][tech];
                            if (target === 0) return;
                            const awarded = (awardedTotals[year] && awardedTotals[year][grid] && awardedTotals[year][grid][tech]) ? awardedTotals[year][grid][tech] : 0;
                            const rate = (awarded / target) * 100;
                            let colorClass = 'text-red-600';
                            if (rate >= 100) colorClass = 'text-green-600';
                            else if (rate > 0) colorClass = 'text-yellow-600';
                            
                            const techName = tech.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `<li>${techName}: <strong class="${colorClass}">${rate.toFixed(1)}%</strong> (${formatNumber(awarded,1)}/${target} MW)</li>`;
                        });
                        html += `</ul></div>`;
                    }
                });
                html += '</div></div>';
            });
            html += '</div>';
            contentEl.innerHTML = html;
        }

        function getLotNumber(year, grid) {
            const lots = { 2026: { Luzon: 1, Visayas: 2, Mindanao: 3 }, 2027: { Luzon: 4, Visayas: 5, Mindanao: 6 }, 2028: { Luzon: 7, Visayas: 8, Mindanao: 9 }, 2029: { Luzon: 10, Visayas: 11, Mindanao: 12 } };
            return lots[year][grid];
        }

        function initMap() {
            map = L.map('map').setView([12.8797, 121.7740], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
            markerLayer = L.layerGroup().addTo(map);
        }

        function updateMap(projectList) {
            markerLayer.clearLayers();
            projectList.forEach(project => {
                if (project.lat && project.lon) {
                    const iconHtml = `<div style="background-color: ${iconColors[project.type] || '#888'};" class="w-4 h-4 rounded-full border-2 border-white shadow-md"></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'custom-map-icon', iconSize: [16, 16], iconAnchor: [8, 8] });
                    const popupContent = `<div class="font-sans"><div class="font-bold text-base mb-1">${project.facilityName}</div><div class="text-sm text-gray-600">${project.developer}</div><hr class="my-2"><div class="text-xs"><strong>Capacity:</strong> ${formatNumber(project.capacity, 3)} MW<br><strong>Technology:</strong> ${project.type}</div></div>`;
                    const marker = L.marker([project.lat, project.lon], { icon: customIcon }).bindPopup(popupContent);
                    markerLayer.addLayer(marker);
                }
            });
        }

        function zoomToGrid(grid) {
            const gridViews = { Luzon: [[15.5, 121], 7], Visayas: [[10.7, 123.5], 8], Mindanao: [[7.8, 125], 7], all: [[12.8797, 121.7740], 6] };
            if(map && gridViews[grid]) { map.flyTo(...gridViews[grid]); }
        }

        function showProjectModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            modalTitle.textContent = project.facilityName;
            modalBody.innerHTML = `<div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm"><div><dt class="text-gray-500">Developer</dt><dd class="text-gray-900 font-medium">${project.developer}</dd></div><div><dt class="text-gray-500">Grid</dt><dd class="text-gray-900 font-medium">${project.grid}</dd></div><div><dt class="text-gray-500">Technology</dt><dd class="text-gray-900 font-medium">${project.type}</dd></div><div><dt class="text-gray-500">Target Year</dt><dd class="text-gray-900 font-medium">${project.year}</dd></div><div><dt class="text-gray-500">Awarded Capacity</dt><dd class="text-gray-900 font-medium">${formatNumber(project.capacity)} MW</dd></div></div>`;
            projectModal.classList.remove('opacity-0', 'pointer-events-none');
            projectModalContent.classList.remove('scale-95');
        }

        function hideProjectModal() {
            projectModal.classList.add('opacity-0', 'pointer-events-none');
            projectModalContent.classList.add('scale-95');
        }

        function formatNumber(value, digits = 3) { return new Intl.NumberFormat('en-US', { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(value); }
        
        function renderTable(projectList) {
            tableBody.innerHTML = '';
            noResultsEl.classList.toggle('hidden', projectList.length > 0);
            projectList.forEach(project => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.dataset.projectId = project.id;
                row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${project.year}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${project.grid}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${project.type}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate" title="${project.facilityName}">${project.facilityName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${project.developer}">${project.developer}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium text-right">${formatNumber(project.capacity)}</td>`;
                tableBody.appendChild(row);
            });
        }
        
        function updateDashboard(projectList) {
            totalCapacityEl.textContent = formatNumber(projectList.reduce((sum, p) => sum + p.capacity, 0), 2);
            projectCountEl.textContent = projectList.length;
        }

        function populateFilters() {
            const types = [...new Set(projects.map(p => p.type))].sort();
            types.forEach(type => typeFilter.add(new Option(type, type)));
            const developers = [...new Set(projects.map(p => p.developer))].sort();
            developers.forEach(dev => developerFilter.add(new Option(dev, dev)));
        }

        function updateCharts(projectList) {
             const dataByTech = projectList.reduce((acc, p) => { acc[p.type] = (acc[p.type] || 0) + p.capacity; return acc; }, {});
            const labels = Object.keys(dataByTech).sort();
            const capacityData = labels.map(label => dataByTech[label]);
            const chartColors = labels.map(label => iconColors[label] || '#888');
            if(capacityChart) capacityChart.destroy();
            capacityChart = new Chart(document.getElementById('capacity-chart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'Total Capacity (MW)', data: capacityData, backgroundColor: chartColors }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
        }
        
        function applyFiltersAndSort() {
            const searchTerm = searchFilter.value.toLowerCase();
            const selectedGrid = gridFilter.value;
            const selectedYear = yearFilter.value;
            const selectedType = typeFilter.value;
            const selectedDeveloper = developerFilter.value;

            currentFilteredProjects = projects.filter(p => 
                (searchTerm === '' || p.facilityName.toLowerCase().includes(searchTerm) || p.developer.toLowerCase().includes(searchTerm)) &&
                (selectedGrid === 'all' || p.grid === selectedGrid) &&
                (selectedYear === 'all' || p.year == selectedYear) &&
                (selectedType === 'all' || p.type === selectedType) &&
                (selectedDeveloper === 'all' || p.developer === selectedDeveloper)
            );

            currentFilteredProjects.sort((a, b) => { let comp = 0; if (a[sortState.column] > b[sortState.column]) comp = 1; else if (a[sortState.column] < b[sortState.column]) comp = -1; return sortState.direction === 'desc' ? comp * -1 : comp; });
            
            renderTable(currentFilteredProjects);
            updateDashboard(currentFilteredProjects);
            updateCharts(currentFilteredProjects);
            updateMap(currentFilteredProjects);
        }

        function resetFilters() {
            searchFilter.value = ''; gridFilter.selectedIndex = 0; yearFilter.selectedIndex = 0; typeFilter.selectedIndex = 0; developerFilter.selectedIndex = 0;
            sortState = { column: 'year', direction: 'asc' };
            applyFiltersAndSort();
            updateSubscriptionPanel();
            zoomToGrid('all');
        }

        function exportToCsv() {
            const headers = ["ID", "Year", "Grid", "Technology", "Project Name", "Developer", "Capacity (MW)"];
            const rows = currentFilteredProjects.map(p => [ p.id, p.year, p.grid, p.type, `"${p.facilityName.replace(/"/g, '""')}"`, `"${p.developer.replace(/"/g, '""')}"`, p.capacity ].join(','));
            const csv = "data:text/csv;charset=utf-8," + [headers.join(',')].concat(rows).join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", "gea4_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        searchFilter.addEventListener('input', applyFiltersAndSort);
        gridFilter.addEventListener('change', () => { applyFiltersAndSort(); updateSubscriptionPanel(); zoomToGrid(gridFilter.value); });
        yearFilter.addEventListener('change', () => { applyFiltersAndSort(); updateSubscriptionPanel(); });
        typeFilter.addEventListener('change', applyFiltersAndSort);
        developerFilter.addEventListener('change', applyFiltersAndSort);
        exportBtn.addEventListener('click', exportToCsv);
        resetBtn.addEventListener('click', resetFilters);
        
        tableHeaders.forEach(header => header.addEventListener('click', () => {
            const column = header.dataset.sort;
            sortState.direction = (sortState.column === column && sortState.direction === 'asc') ? 'desc' : 'asc';
            sortState.column = column;
            applyFiltersAndSort();
        }));
        
        tableBody.addEventListener('click', (event) => {
            const row = event.target.closest('tr');
            if (row && row.dataset.projectId) {
                const projectId = parseInt(row.dataset.projectId);
                const project = projects.find(p => p.id === projectId);
                if (project && project.lat && project.lon) {
                    map.flyTo([project.lat, project.lon], 12, { animate: true, duration: 1 });
                }
                showProjectModal(projectId);
            }
        });

        modalCloseBtn.addEventListener('click', hideProjectModal);
        projectModal.addEventListener('click', (event) => { if (event.target === projectModal) hideProjectModal(); });

        ratePanelToggle.addEventListener('click', () => {
            const content = ratePanelContent;
            const arrow = rateArrow;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.style.transform = 'rotate(180deg)';
            }
        });

        // --- WIND TURBINE ANIMATION ---
        const turbineBlades = document.getElementById('turbine-blades');
        let currentRotation = 0, rotationSpeed = 0.5, slowdownInterval;
        const baseSpeed = 0.5;
        function animateTurbine() { currentRotation = (currentRotation + rotationSpeed) % 360; turbineBlades.style.transform = `rotate(${currentRotation}deg)`; requestAnimationFrame(animateTurbine); }
        function slowDown() { clearInterval(slowdownInterval); const start = rotationSpeed, reduction = start - baseSpeed, duration = 4000, steps = 200, stepReduction = reduction/steps; if (reduction <= 0) return; slowdownInterval = setInterval(() => { rotationSpeed -= stepReduction; if (rotationSpeed <= baseSpeed) { rotationSpeed = baseSpeed; clearInterval(slowdownInterval); } }, duration/steps); }
        setInterval(() => { if (rotationSpeed === baseSpeed && Math.random() > 0.6) { rotationSpeed = 2.0 + Math.random() * 2; setTimeout(slowDown, 1000); } }, 3000);
        document.addEventListener('click', (event) => { if (event.target.closest('select, button, input, a, .leaflet-container')) return; rotationSpeed = 6.0 + Math.random() * 4; slowDown(); });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            populateFilters();
            calculateAwardedTotals();
            updateSubscriptionPanel();
            applyFiltersAndSort();
            animateTurbine();
        });
    </script>
</body>
</html>

